<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng ký Thông báo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
        }

        .container {
            max-width: 600px;
            margin: auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            margin-top: 20px;
            cursor: pointer;
        }

        #password-container {
            margin-top: 20px;
        }

        #password-input {
            padding: 10px;
            font-size: 16px;
            margin-right: 10px;
        }

        #subscribe-btn {
            display: none;
        }

        .error-message {
            color: red;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Nhận Thông Báo Mới Nhất</h1>
        <p>Nhập mật khẩu để đăng ký nhận thông báo.</p>

        <div id="password-container">
            <input type="password" id="password-input" placeholder="Nhập mật khẩu">
            <button id="verify-btn">Xác nhận</button>
            <p id="error-message" class="error-message">Mật khẩu không đúng!</p>
        </div>

        <button id="subscribe-btn">Đăng ký thông báo</button>
    </div>
    
    <!-- OneSignal script will be loaded dynamically after password verification -->
    
    <script>
        let oneSignalInitialized = false;
        let OneSignal;

        // Password verification
        document.addEventListener('DOMContentLoaded', function() {
            const correctPassword = "1235"; // Your password
            const passwordInput = document.getElementById('password-input');
            const verifyBtn = document.getElementById('verify-btn');
            const errorMessage = document.getElementById('error-message');
            const subscribeBtn = document.getElementById('subscribe-btn');
            const passwordContainer = document.getElementById('password-container');

            verifyBtn.addEventListener('click', function() {
                if (passwordInput.value === correctPassword) {
                    // Password is correct
                    passwordContainer.style.display = 'none';
                    subscribeBtn.style.display = 'inline-block';
                    
                    // Only now load the OneSignal SDK
                    loadOneSignalSDK();
                } else {
                    // Password is incorrect
                    errorMessage.style.display = 'block';
                    setTimeout(() => {
                        errorMessage.style.display = 'none';
                    }, 3000);
                }
            });

            // Handle subscribe button click
            subscribeBtn.addEventListener('click', function() {
                if (oneSignalInitialized) {
                    // Force reset the slidedown state so it appears again even after "Later" is clicked
                    resetOneSignalPrompt();
                } else {
                    // If OneSignal isn't initialized yet, wait and try again
                    setTimeout(() => {
                        if (oneSignalInitialized) {
                            resetOneSignalPrompt();
                        } else {
                            alert("Đang kết nối tới máy chủ thông báo. Vui lòng thử lại sau.");
                        }
                    }, 2000);
                }
            });
        });
        
        // Function to reset OneSignal prompt state and show it again
        function resetOneSignalPrompt() {
            // Check if user has already been prompted
            OneSignal.Notifications.areEnabled().then(function(isEnabled) {
                if (!isEnabled) {
                    // If not enabled, clear any previous interaction state and show the prompt
                    OneSignal.User.Slidedown.clearSlidedownSession();
                    // Show the prompt again
                    OneSignal.showSlidedownPrompt({force: true});
                } else {
                    // If already enabled, show a message
                    alert("Bạn đã đăng ký nhận thông báo!");
                }
            });
        }
        
        // Function to load OneSignal SDK after password verification
        function loadOneSignalSDK() {
            const script = document.createElement('script');
            script.src = 'https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js';
            script.defer = true;
            document.body.appendChild(script);
            
            // Initialize OneSignal after script loads
            script.onload = function() {
                window.OneSignalDeferred = window.OneSignalDeferred || [];
                OneSignalDeferred.push(async function(OneSignalSDK) {
                    OneSignal = OneSignalSDK;
                    await OneSignal.init({
                        appId: "bcd53a6d-e73c-4e24-9417-1086f25eff31",
                        safari_web_id: "web.onesignal.auto.3377791d-2467-4a62-9fdc-3aca1a0bc947",
                        notifyButton: {
                            enable: false, // Disable notification button initially
                        },
                        allowLocalhostAsSecureOrigin: true,
                        promptOptions: {
                            slidedown: {
                                prompts: [
                                    {
                                        type: "push",
                                        autoPrompt: false,
                                    }
                                ]
                            }
                        }
                    });
                    oneSignalInitialized = true;
                });
            };
        }
    </script>
</body>

</html>